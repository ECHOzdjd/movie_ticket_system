# 架构设计文档

## 系统架构概述

本系统采用微服务架构，基于Spring Cloud生态构建，主要包含以下组件：

- **API网关** (Gateway Service): 统一入口，路由转发，鉴权
- **影片资源服务** (Movie Resource Service): 管理影片、影院、场次信息
- **订单业务服务** (Order Biz Service): 管理用户、选座、订单
- **服务注册中心** (Nacos): 服务注册与发现，配置管理
- **数据存储** (MySQL + Redis): MySQL存储业务数据，Redis用于缓存和分布式锁

## 技术架构

### 技术栈

```
┌─────────────────────────────────────────┐
│          前端/客户端                      │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│      Spring Cloud Gateway               │
│      (路由、鉴权、限流)                   │
└──┬────────────┬────────────┬────────────┘
   │            │            │
┌──▼──┐    ┌───▼────┐   ┌───▼────┐
│Movie│    │ Order  │   │  ...   │
│Service│   │ Service │   │ Service │
└──┬──┘    └───┬────┘   └───┬────┘
   │           │            │
   │      ┌────▼────┐       │
   │      │ OpenFeign│       │
   │      └────┬────┘       │
   │           │            │
┌──▼───────────▼───────────▼──┐
│       Nacos (注册中心)       │
└─────────────────────────────┘
   │           │            │
┌──▼──┐    ┌──▼────┐   ┌───▼────┐
│MySQL│    │ Redis │   │  ...   │
└─────┘    └───────┘   └────────┘
```

### 分层架构

#### 1. 网关层 (Gateway Layer)

**职责**:
- 统一API入口
- 请求路由转发
- 统一鉴权（JWT Token验证）
- 跨域处理
- 请求日志记录

**技术实现**:
- Spring Cloud Gateway
- GlobalFilter实现鉴权逻辑
- 白名单机制（登录、注册等接口不需要认证）

#### 2. 服务层 (Service Layer)

**影片资源服务** (movie-resource-service):
- **Controller层**: 接收HTTP请求，参数校验
- **Service层**: 业务逻辑处理
- **Mapper层**: 数据访问（MyBatis Plus）
- **Entity层**: 数据模型

**订单业务服务** (order-biz-service):
- **Controller层**: 接收HTTP请求，参数校验
- **Service层**: 业务逻辑处理（用户、选座、订单）
- **Mapper层**: 数据访问（MyBatis Plus）
- **Entity层**: 数据模型
- **Feign客户端**: 调用影片资源服务

#### 3. 数据层 (Data Layer)

**MySQL**:
- 存储业务数据（用户、影片、订单等）
- 支持事务，保证数据一致性

**Redis**:
- 缓存热点数据
- 分布式锁（座位锁定）
- 订单过期时间管理

## 核心设计

### 1. 服务拆分原则

- **按业务领域拆分**: 影片资源、订单业务
- **高内聚低耦合**: 每个服务职责单一，通过API通信
- **数据独立**: 每个服务拥有独立的数据库

### 2. 服务间通信

- **同步调用**: 使用OpenFeign进行HTTP同步调用
- **服务发现**: 通过Nacos进行服务注册与发现
- **负载均衡**: Spring Cloud LoadBalancer自动负载均衡

### 3. 认证与授权

- **认证方式**: JWT Token
- **Token生成**: 登录成功后由服务端生成
- **Token验证**: 网关层统一验证，验证通过后转发请求
- **用户信息传递**: 通过请求头 `X-User-Id` 传递用户ID

### 4. 分布式锁设计

**场景**: 在线选座防止重复选择

**实现方案**:
- 使用Redis实现分布式锁
- Key格式: `seat:lock:{scheduleId}:{seatNumber}`
- 锁过期时间: 5分钟
- 锁机制: SETNX + EXPIRE

**流程**:
1. 用户选择座位
2. 尝试获取Redis锁
3. 如果获取成功，锁定座位
4. 如果获取失败，返回座位已被锁定
5. 创建订单后，支付成功则释放锁
6. 订单超时或取消，自动释放锁

### 5. 订单超时处理

**实现方案**:
- 使用Spring的@Scheduled定时任务
- 每分钟扫描一次待支付订单
- 如果订单过期时间已到，自动取消订单
- 取消订单时释放座位锁，更新订单状态

### 6. 异常处理

- **全局异常处理**: 使用@RestControllerAdvice统一处理异常
- **业务异常**: 使用BusinessException封装业务异常
- **统一响应**: 所有接口返回统一的Result格式

### 7. 数据一致性

**最终一致性**:
- 订单创建时锁定座位（Redis锁）
- 订单支付成功后更新场次已售座位数
- 订单取消时释放座位锁
- 使用本地事务保证单个服务内的数据一致性

**避免分布式事务**:
- 优先考虑避免分布式事务
- 通过最终一致性保证数据正确性
- 使用补偿机制处理异常情况

## 部署架构

### 容器化部署

- **Docker**: 每个服务独立容器化
- **Docker Compose**: 统一编排，一键启动
- **网络隔离**: 使用Docker网络，服务间通过服务名通信

### 服务依赖关系

```
gateway-service
  └─> movie-resource-service
  └─> order-biz-service
       └─> movie-resource-service (Feign)
       └─> MySQL
       └─> Redis

movie-resource-service
  └─> MySQL
  └─> Nacos

所有服务
  └─> Nacos (注册中心)
```

## 性能优化

1. **缓存策略**: 热点数据（影片列表、影院列表）可以缓存到Redis
2. **数据库索引**: 关键字段建立索引（用户ID、订单号、场次ID等）
3. **连接池**: 使用HikariCP数据库连接池
4. **异步处理**: 订单过期检查使用定时任务，不阻塞主流程

## 扩展性设计

1. **水平扩展**: 每个服务可以多实例部署，通过Nacos负载均衡
2. **数据库分库分表**: 订单表可以按时间或用户ID分表
3. **缓存集群**: Redis可以部署集群模式
4. **消息队列**: 未来可以引入消息队列处理异步任务（订单创建、支付回调等）

## 安全性设计

1. **密码加密**: 使用BCrypt加密存储
2. **Token安全**: JWT Token设置过期时间，防止Token泄露
3. **SQL注入防护**: 使用MyBatis Plus参数化查询
4. **XSS防护**: 输入参数校验和转义
5. **接口限流**: 网关层可以配置限流规则（未来可以集成Sentinel）

## 监控与运维

1. **服务注册**: 通过Nacos查看服务注册状态
2. **日志聚合**: 各服务输出结构化日志
3. **健康检查**: Spring Boot Actuator健康检查端点（可扩展）
4. **链路追踪**: 可以集成Sleuth + Zipkin（未来扩展）

## 开发规范

1. **代码分层**: Controller -> Service -> Mapper -> Entity
2. **异常处理**: 统一使用BusinessException，全局异常处理器捕获
3. **日志规范**: 使用SLF4J，关键操作记录日志
4. **接口规范**: RESTful API设计，统一响应格式
5. **数据库规范**: 表名小写，字段下划线命名

